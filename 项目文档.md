# HIIC HR AI应用项目文档

## 1. 项目整体架构

### 1.1 项目概述
HIIC HR AI应用是一个基于Supabase HR数据的AI对话和数据可视化应用。该应用提供AI对话问答、数据可视化、员工数据查询和统计分析等功能，支持多种大模型，并能根据问题类型智能选择最佳回答方式。

### 1.2 技术栈
- **后端**：FastAPI, Python, LangChain, OpenRouter, Supabase, Pandas, NumPy, Matplotlib, Seaborn
- **前端**：Next.js, React, Tailwind CSS, Axios, React Hooks, ECharts

### 1.3 系统架构图
```
+------------------+    +------------------+    +------------------+
|                  |    |                  |    |                  |
|  前端 (Next.js)   +--->+  后端 (FastAPI)   +--->+  数据库 (Supabase) |
|                  |    |                  |    |                  |
+------------------+    +------------------+    +------------------+
                              |
                              v
                        +------------------+
                        |                  |
                        |  AI服务 (OpenRouter)|
                        |                  |
                        +------------------+
```

## 2. 代码文件依赖关系

### 2.1 后端依赖关系
```
app/main.py                  # 应用入口点
├── app/routers/chat.py      # 聊天路由
│   ├── app/services/chat_service.py           # 基础聊天服务
│   ├── app/services/enhanced_chat_service.py  # 增强聊天服务
│   └── app/services/hybrid_chat_service.py    # 混合聊天服务
├── app/routers/visualizations.py              # 可视化路由
│   └── app/services/visualization_service.py  # 可视化服务
├── app/db/supabase.py       # Supabase数据库连接
├── app/models/hr_models.py  # 数据模型定义
├── app/services/sql_service.py               # SQL查询服务
├── app/services/data_analysis_service.py     # 数据分析服务
├── app/services/question_classifier.py       # 问题分类器
├── app/services/tool_service.py              # 工具服务
└── app/services/openrouter_service.py        # OpenRouter服务
```

### 2.2 前端依赖关系
```
src/app/layout.tsx           # 应用布局
├── src/app/page.tsx         # 首页
├── src/app/chat/page.tsx    # 聊天页面
│   ├── src/components/Chat.tsx              # 聊天组件
│   ├── src/components/VisualChart.tsx       # 可视化图表组件
│   └── src/services/api.ts                  # API服务
├── src/app/visualizations/page.tsx          # 可视化页面
│   ├── src/components/charts/BarChart.js    # 柱状图组件
│   ├── src/components/charts/PieChart.js    # 饼图组件
│   ├── src/components/charts/HorizontalBarChart.js # 水平柱状图组件
│   └── src/components/dialogs/EmployeeListDialog.js # 员工列表对话框
├── src/app/employees/       # 员工页面
├── src/contexts/AuthContext.tsx             # 认证上下文
└── src/lib/supabase.ts                      # Supabase客户端
```

## 3. 功能模块调用逻辑

### 3.1 聊天功能流程
```
用户输入 -> 前端Chat组件 -> API服务 -> 后端chat路由 -> 
问题分类器 -> {
  SQL查询问题 -> SQL服务 -> 数据库查询 -> 结果处理
  数据分析问题 -> 数据分析服务 -> 数据处理 -> 结果生成
  可视化问题 -> 可视化服务 -> 图表生成 -> 结果返回
  一般问题 -> OpenRouter服务 -> AI模型 -> 回答生成
} -> 
响应处理 -> 前端展示
```

### 3.2 数据流转逻辑
```
Supabase数据库 -> SupabaseClient类 -> 
{
  员工数据 -> 员工模型
  部门数据 -> 部门模型
  教育数据 -> 教育模型
  工作经验数据 -> 工作经验模型
  职称数据 -> 职称模型
  工作变动数据 -> 工作变动模型
  晋升数据 -> 晋升模型
  奖项数据 -> 奖项模型
} -> 
数据处理服务 -> API响应 -> 前端展示
```

### 3.3 AI服务调用逻辑
```
用户问题 -> 问题分类器 -> 
{
  传统方式 -> chat_service -> OpenRouter -> AI模型
  工具调用方式 -> enhanced_chat_service -> OpenRouter -> AI模型 -> 工具调用
  混合方式 -> hybrid_chat_service -> {
    SQL查询 -> sql_service -> 数据库
    数据分析 -> data_analysis_service -> 数据处理
    工具调用 -> tool_service -> 功能执行
  }
} -> 
结果整合 -> 响应生成
```

### 3.4 可视化功能流程
```
前端可视化页面 -> API服务 -> 后端visualizations路由 ->
visualization_service -> {
  部门分布 -> department_distribution()
  性别分布 -> gender_distribution()
  年龄分布 -> age_distribution()
  学历分布 -> education_distribution()
  高校分布 -> university_distribution()
  工作年限分布 -> work_years_distribution()
} ->
数据处理 -> 前端ECharts展示 -> 
用户点击图表 -> 获取员工列表 -> 
get_employees_by_category() -> 
员工列表对话框展示
```

## 4. 关键代码文件定位索引

### 4.1 后端核心文件
| 文件路径 | 功能描述 | 关键类/函数 |
|---------|---------|------------|
| `hiic-hr-app/backend/app/main.py` | 后端入口点 | FastAPI应用初始化、中间件配置、路由注册 |
| `hiic-hr-app/backend/app/routers/chat.py` | 聊天路由 | `send_message`, `send_enhanced_message`, `send_hybrid_message` |
| `hiic-hr-app/backend/app/services/chat_service.py` | 基础聊天服务 | `hr_chat_service.get_response` |
| `hiic-hr-app/backend/app/services/hybrid_chat_service.py` | 混合聊天服务 | `hybrid_chat_service.get_response` |
| `hiic-hr-app/backend/app/services/sql_service.py` | SQL查询服务 | SQL生成、执行和结果处理 |
| `hiic-hr-app/backend/app/db/supabase.py` | 数据库连接 | `SupabaseClient`类、数据查询方法 |
| `hiic-hr-app/backend/app/models/hr_models.py` | 数据模型 | 各种HR数据模型定义 |
| `hiic-hr-app/backend/app/services/question_classifier.py` | 问题分类器 | 问题类型识别和路由 |
| `hiic-hr-app/backend/app/services/visualization_service.py` | 可视化服务 | 数据可视化生成、员工列表筛选 |
| `hiic-hr-app/backend/app/routers/visualizations.py` | 可视化路由 | 可视化数据API端点 |

### 4.2 前端核心文件
| 文件路径 | 功能描述 | 关键组件/函数 |
|---------|---------|-------------|
| `hiic-hr-app/frontend/src/app/chat/page.tsx` | 聊天页面 | `ChatPage`组件、消息处理逻辑 |
| `hiic-hr-app/frontend/src/components/Chat.tsx` | 聊天组件 | 聊天界面UI、消息展示 |
| `hiic-hr-app/frontend/src/components/VisualChart.tsx` | 可视化图表 | 数据可视化展示 |
| `hiic-hr-app/frontend/src/services/api.js` | API服务 | 前后端通信、请求处理 |
| `hiic-hr-app/frontend/src/app/layout.tsx` | 应用布局 | 全局布局、导航组件 |
| `hiic-hr-app/frontend/src/app/visualizations/page.tsx` | 可视化页面 | 可视化页面组件、图表配置 |
| `hiic-hr-app/frontend/src/components/charts/BarChart.js` | 柱状图组件 | 柱状图渲染、事件处理 |
| `hiic-hr-app/frontend/src/components/charts/PieChart.js` | 饼图组件 | 饼图渲染、事件处理 |
| `hiic-hr-app/frontend/src/components/charts/HorizontalBarChart.js` | 水平柱状图组件 | 水平柱状图渲染、事件处理 |
| `hiic-hr-app/frontend/src/components/dialogs/EmployeeListDialog.js` | 员工列表对话框 | 员工列表展示、筛选功能 |

## 5. 数据模型结构

### 5.1 核心数据模型
- **Employee**: 员工基本信息（ID、姓名、性别、年龄、部门等）
- **Department**: 部门信息（ID、名称）
- **Education**: 教育背景（大学、专业、学历等）
- **WorkExperience**: 工作经验（入职日期、工作年限等）
- **Title**: 职称信息
- **JobChange**: 工作变动记录
- **Promotion**: 晋升记录
- **Award**: 奖项记录

### 5.2 API数据模型
- **ChatMessage**: 聊天消息模型（角色、内容）
- **ChatRequest**: 聊天请求模型（消息列表）
- **ChatResponse**: 聊天响应模型（响应内容）
- **StatsResponse**: 统计响应模型（部门、性别、年龄、教育统计）
- **VisualizationData**: 可视化数据模型（标题、描述、数据、统计信息）

## 6. API接口文档

### 6.1 聊天接口
- **POST /chat/send**: 发送聊天消息（传统方式）
- **POST /chat/enhanced/send**: 发送增强聊天消息（工具调用方式）
- **POST /chat/hybrid/send**: 发送混合聊天消息（工具调用+SQL方式）
- **GET /chat/health**: 聊天服务健康检查

### 6.2 数据接口
- **GET /api/employees**: 获取所有员工
- **GET /api/employees/{id}**: 获取特定员工
- **GET /api/departments/{department}/employees**: 获取部门员工
- **GET /api/stats**: 获取统计数据
- **GET /api/visualizations**: 获取所有可视化图表
- **GET /api/visualizations/{type}**: 获取特定类型的可视化
- **GET /api/visualizations/employees/{visualization_type}**: 获取特定可视化分类下的员工列表

## 7. 功能特点详解

### 7.1 AI对话问答
系统支持多种问答模式：
- SQL查询：自动将自然语言转换为SQL查询
- 数据分析：使用Pandas进行数据分析
- 混合模式：根据问题类型自动选择最佳回答方式
- 上下文记忆：支持多轮对话，保持上下文连贯性

### 7.2 数据可视化
提供多种HR数据的可视化图表：
- 部门人员分布：展示各部门人员数量分布情况
- 性别比例：展示公司员工性别比例分布
- 年龄分布：展示公司员工年龄段分布情况
- 学历分布：展示公司员工学历层次分布情况
- 高校分布：展示员工毕业院校分布情况（Top 10）
- 工作年限分布：展示员工工作经验年限分布情况

每个图表都支持点击交互，点击后显示该分类下的员工详细列表，并提供筛选功能。图表支持暗色/亮色主题切换，自适应屏幕大小。

### 7.3 员工数据查询
支持多种查询方式：
- 按ID查询
- 按部门查询
- 按姓名查询
- 复合条件查询

### 7.4 统计分析
提供各种HR数据的统计分析：
- 部门人数统计
- 性别比例分析
- 年龄段分布
- 学历层次分析
- 工作年限分析

## 8. 开发与部署指南

### 8.1 环境要求
- Python 3.9+
- Node.js 18+
- 有效的OpenRouter API密钥
- Supabase账号和项目

### 8.2 安装步骤
1. 克隆仓库
2. 安装后端依赖
3. 配置后端环境变量
4. 运行后端服务
5. 安装前端依赖
6. 配置前端环境变量
7. 运行前端服务

### 8.3 部署流程
1. 后端部署：可使用Docker容器或直接部署到服务器
2. 前端部署：可使用Vercel、Netlify等平台或直接部署到Web服务器
3. 数据库配置：确保Supabase项目配置正确，并设置适当的安全规则
4. 环境变量设置：确保所有必要的环境变量在生产环境中正确设置

## 9. 最近更新

### 9.1 教育统计指标优化 (2023-07-15)
- 移除了"专科及以下比例"指标，不再显示在统计数据中
- 新增"硕士及以上比例"指标，展示高学历人才占比
- 新增"海外学历占比"指标，统计具有海外教育背景的员工比例
- 新增"985/211院校占比"指标，统计毕业于国内重点高校的员工比例
- 优化了"学历结构评分"的计算逻辑和解释说明，使其更加清晰
- 前后端同步修改，确保数据一致性

### 9.2 职业发展信息显示优化 (2023-07-15)
- 改进了职业发展信息的解析和显示逻辑
- 优化了年份提取算法，支持多种格式（如"2020年"、"2020-"等）
- 改进了时间线显示，更清晰地展示职业发展历程
- 修复了显示异常字符（如"年"和"，"）的问题
- 增强了文本清理功能，提供更整洁的信息展示 